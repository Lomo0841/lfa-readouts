{% extends 'base.html' %}

{% block head %} 
    <title>LFA Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}"> 
{% endblock %}

{% block body %}
  <!-- UI: https://sites.google.com/site/prakashbebington/multimedia-development-resources/gui-design-principles -->
  <div class="container">
    <div class="form-container">
      <div class="image-container">
        
        {% if is_video %}
        <form id="cap_form" method="GET" action="{{ url_for('cap_image') }}"></form> 
        <form id="load_form" method="POST" action="{{ url_for('load_image') }}" enctype="multipart/form-data"></form> 

        <img class="lfa-image" src="{{ url_for('live_image') }}" alt="LFA image" />
        <div class="button-group">
          <button type="submit" form="cap_form">
            <img src="{{ url_for('static', filename='assets/camera_icon.svg') }}" alt="Camera icon">
            Capture Image
          </button>
          <!-- <button type="submit" form="load_form">Choose Image File</button> -->
          <input type="file" name="file" id="file_input" accept="image/*" style="display:none" form="load_form" />
          <button type="button" onclick="document.getElementById('file_input').click()">
            <img src="{{ url_for('static', filename='assets/folder_icon.svg') }}" alt="Folder icon">
            Select Image
          </button>
        </div>
        {% else %}
        <form id="reset_form" action="{{ url_for('reset') }}"></form>

        <img class="lfa-image" src="data:image/png;base64,{{ input_image }}" id="lfa_image" alt="LFA image"/>
        <div class="retake-button">
          <button type="submit" form="reset_form">
            <img src="{{ url_for('static', filename='assets/redo_icon.svg') }}" alt="Redo icon">
            Retake Image
          </button>
        </div>
        {% endif %}
      </div>

      <!-- https://stackoverflow.com/questions/379610/can-you-nest-html-forms -->
      
      <form id="post_form"  method="POST" action="{{ url_for('post_data') }}"></form>
      <form id="algo_form" method="GET" action="{{ url_for('run_algorithm') }}"></form> 
      
      <div class="form-group">
        <div class="header-group">
          <h2>Calibrate Filters</h2>
          <!-- Button to trigger modal -->
          <button id="settings-button">
            <img src="{{ url_for('static', filename='assets/gear_icon.svg') }}" alt="Settings icon">
          </button>
        </div>
        <label for="center">
          Expected Center (x,y) 
          <div id="center-help" class="help-div">?</div>
        </label>
        
        <div class="input-group-x-y">
          <input type="number" name="center_x" id="center_x" value="{{x}}" form="post_form"/>
          <input type="number" name="center_y" id="center_y" value="{{y}}" form="post_form"/>
        </div>
        
        <label for="max_dist">
          Maximum Expected Center Distance 
          <div id="dist-help" class="help-div">?</div>
        </label>
        <input type="number" name="max_dist" id="max_dist" value="{{maxDist}}" form="post_form"/>
        <label for="min_area">
          Minimum Area
          <div id="area-help" class="help-div">?</div>
        </label>
        <input type="number" name="min_area" id="min_area" value="{{minArea}}" form="post_form"/>
        <label for="max_defect">
          Maximum Convexity Defect
          <div id="defect-help" class="help-div">?</div>
        </label>
        <input type="number" name="max_defect" id="max_defect" value="{{maxDefect}}" form="post_form"/>
        <div class="button-group">
          <button type="submit" form="post_form">
            <img src="{{ url_for('static', filename='assets/update_icon.svg') }}" alt="Update icon">
            Update Config File
          </button>
          <button type="submit" form="algo_form">
            <img src="{{ url_for('static', filename='assets/action_icon.svg') }}" alt="Action icon">
            Run Algorithm
          </button>
        </div>
      </div>
    



      <!-- Modal container -->
<div class="modal-container">
  <!-- Modal content -->
  <div class="modal-content">
    <h2>Advanced Settings</h2>

    <div class="horizontal-flex">
      <div class="vertical-flex">
        <label>Roi Extractor</label>
        <label>
          <input type="radio" name="RoiOptions" value="AprilTagsExtractor" form="post_form">
          AprilTags
        </label>
      </div>
      <div class="vertical-flex">
        <label>White Balancing</label>
        <label>
          <input type="radio" name="WhiteOptions" value="MaxRGB" form="post_form">
          Max RGB
        </label>
        <label>
          <input type="radio" name="WhiteOptions" value="GreyWorld" form="post_form">
          Grey World
        </label>
        <label>
          <input type="radio" name="WhiteOptions" value="None" form="post_form">
          None
        </label>
      </div>
      <div class="vertical-flex">
        <label>Contour Detector</label>
        <label>
          <input type="radio" name="DetectorOptions" value="BlurThresholdContourDetector" form="post_form">
          Gaussian Blur
        </label>
        <label>
          <input type="radio" name="DetectorOptions" value="AltContourDetector" form="post_form">
          Median Blur
        </label>
      </div>
      <div class="vertical-flex">
        <label>Contour Filtrator</label>
        <label>
          <input type="radio" name="FiltratorOptions" value="FilterOnConditions" form="post_form">
          Use Conditions
        </label>
      </div>
      <div class="vertical-flex">
        <label>Contour Selector</label>
        <label>
          <input type="radio" name="SelectorOptions" value="HierarchicalSelector" form="post_form">
          Hierarchical
        </label>
      </div>
    </div>
    <div class="horizontal-flex">
      <div class="vertical-flex">
        <label for="kernel_size">Kernel Size (Blur)</label>
        <input type="number" name="kernel_size" id="kernel_size" value="{{kernelSize}}" form="post_form"/>
      </div>
      <div class="vertical-flex">
        <label for="write">Save file</label>
        <input type="checkbox" name="write" id="write" value="True" form="post_form" checked="{{write}}"/>
      </div>
    </div>
  </div>
</div>







      
    </div>
  </div>

  <script>
    //https://www.w3schools.com/howto/howto_js_trigger_button_enter.asp

        // Get modal container and button elements
    const modalContainer = document.querySelector('.modal-container');
    const modalBtn = document.querySelector('#settings-button');

    // Add event listener to button to toggle modal display
    modalBtn.addEventListener('click', function() {
      modalContainer.style.display = 'block';
    });

    // Add event listener to modal container to hide modal when clicked outside of content
    modalContainer.addEventListener('click', function(event) {
      if (event.target === modalContainer) {
        modalContainer.style.display = 'none';
      }
    });



    fileInput = document.getElementById('file_input')
    if (fileInput){
      fileInput.addEventListener('change', function(){
              document.getElementById('load_form').submit();
           });
    }

    addDrawOnEnter(document.getElementById("center_x"))
    addDrawOnEnter(document.getElementById("center_y"))
    addDrawOnEnter(document.getElementById("min_area"))
    addDrawOnEnter(document.getElementById("max_dist"))
    //DrawOnEnter Convexity Defect?
    document.getElementById("max_defect").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
          event.preventDefault();            
        }
      });
    
    document.getElementById("kernel_size").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
          event.preventDefault();            
        }
      });

               
    var image = document.getElementById('lfa_image');
    if(image){
      image.addEventListener('click', function(event) {
          var x = event.offsetX;
          var y = event.offsetY;
  
          document.getElementById('center_x').value = x;
          document.getElementById('center_y').value = y;
          drawOnImage("data:image/png;base64,{{ input_image }}", x, y);
      });
    }


    function drawOnImage(imageUrl, centerX, centerY) {
// Create a new image element and load the image from the URL
        var image = new Image();
        image.src = imageUrl; 

// Wait for the image to load
        image.onload = function() {
            // Get a reference to the canvas element and its context
            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');
            var existingImage = document.getElementById('lfa_image');

            // Set the canvas size to match the image size
            existingWidth = existingImage.width;
            existingHeight = existingImage.height;

            canvas.width = existingWidth
            canvas.height = existingHeight

            // Draw the image on the canvas
            context.drawImage(image, 0, 0, existingWidth, existingHeight);

            // CIRCLEDRAW?
            area = document.getElementById('min_area').value;
            radius = Math.sqrt(area / Math.PI)
            //Is linewidth wierd? changes size of circle?
            drawCircle(context, centerX, centerY, radius)
            
            //LINEDRAW?
            maxDist = document.getElementById('max_dist').value;
            drawLineFromPoint(context, centerX, centerY, parseInt(maxDist))
            

                
            // Replace the image with the modified canvas
            existingImage.src = canvas.toDataURL();

        };
    }

    function addDrawOnEnter(input) {
        // Execute a function when the user presses a key on the keyboard
        input.addEventListener("keypress", function(event) {
            // If the user presses the "Enter" key on the keyboard
            if (event.key === "Enter") {
                // Cancel the default action, if needed
                event.preventDefault();
                // Trigger the button element with a click
                drawOnImage("data:image/png;base64,{{ input_image }}", parseInt(document.getElementById('center_x').value), parseInt(document.getElementById('center_y').value))
            }
        });
    }

    function drawCircle(context, x, y, radius) {
      context.beginPath();
            context.arc(x, y, radius, 0, 2 * Math.PI, false);
            context.strokeStyle = `rgb(0,255,0)`;
            context.lineWidth = 3;    
            context.stroke();
    }

    function drawLineFromPoint(context, startX, startY, length) {
      endX = startX + length;
      context.beginPath();
      context.moveTo(startX, startY);
      context.lineTo(endX, startY);
      context.stroke();
    }
//data:image/png;base64,{{ inputImage }}

</script>

{% endblock %}

